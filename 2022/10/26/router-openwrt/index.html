<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="路由器openwrt相关"><meta name="keywords" content=""><meta name="author" content="Ray Qu"><meta name="copyright" content="Ray Qu"><title>路由器openwrt相关 | My Notes</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 7.3.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6"><span class="toc-number">1.</span> <span class="toc-text">硬件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E6%8B%93%E6%89%91"><span class="toc-number">2.</span> <span class="toc-text">网络拓扑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B7breed"><span class="toc-number">3.</span> <span class="toc-text">刷breed</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#R3G"><span class="toc-number">3.1.</span> <span class="toc-text">R3G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#R6220"><span class="toc-number">3.2.</span> <span class="toc-text">R6220</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E7%BA%BF%E4%B8%AD%E7%BB%A7%E6%96%B9%E6%A1%88"><span class="toc-number">4.</span> <span class="toc-text">无线中继方案</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%B7%AF%E7%94%B1R3G"><span class="toc-number">4.1.</span> <span class="toc-text">主路由R3G</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%AF%E8%B7%AF%E7%94%B1R6220"><span class="toc-number">4.2.</span> <span class="toc-text">副路由R6220</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#easymesh%E6%96%B9%E6%A1%88-%E5%9B%A0%E4%B8%BAR3G%E8%87%AA%E7%BC%96%E8%AF%91%E5%B8%A6easymesh%E7%9A%84openwrt%E4%B8%8D%E7%A8%B3%E5%AE%9A%EF%BC%8C%E6%94%BE%E5%BC%83easymesh"><span class="toc-number">5.</span> <span class="toc-text">easymesh方案 (因为R3G自编译带easymesh的openwrt不稳定，放弃easymesh)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91R3G-openwrt"><span class="toc-number">5.1.</span> <span class="toc-text">编译R3G openwrt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91R6220-openwrt"><span class="toc-number">5.2.</span> <span class="toc-text">编译R6220 openwrt</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#R6220-openwrt-2-4G%E4%B8%A2%E5%A4%B1%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.1.</span> <span class="toc-text">R6220 openwrt 2.4G丢失问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%81%E8%B7%AF%E7%94%B1%E7%BD%91%E5%85%B3"><span class="toc-number">6.</span> <span class="toc-text">旁路由网关</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">Ray Qu</div><div class="author-info__description text-center">My Tech Notes and Other stuff</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">75</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">My Notes</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/about.html">About</a><a class="site-page" href="/contact.html">Contact</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">路由器openwrt相关</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-10-26</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>路由器无线组网相关记录。</p>
<h2 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h2><ol>
<li>Netgear R6220</li>
<li>小米R3G</li>
</ol>
<p>两个路由都是MT7621,128M Flash, 256M内存。都有breed。都可以刷padavan, openwrt。<br>R6220是1千兆WAN+4千兆LAN+1USB2.0，2.4G+5G双频1200M。准备接USB打印机做打印服务器。<br>小米R3G是1千兆WAN+2千兆LAN+1USB3.0，2.4G+5G双频1200M。准备接移动硬盘做文件服务器。</p>
<h2 id="网络拓扑"><a href="#网络拓扑" class="headerlink" title="网络拓扑"></a>网络拓扑</h2><p>TODO</p>
<h2 id="刷breed"><a href="#刷breed" class="headerlink" title="刷breed"></a>刷breed</h2><h3 id="R3G"><a href="#R3G" class="headerlink" title="R3G"></a>R3G</h3><p>刷breed的方法参考<a href="https://www.cnblogs.com/milton/p/16163521.html">https://www.cnblogs.com/milton/p/16163521.html</a></p>
<p>breed下载网址<a href="https://breed.hackpascal.net/">https://breed.hackpascal.net/</a><br>对应R3G的文件是breed-mt7621-xiaomi-r3g.bin</p>
<h3 id="R6220"><a href="#R6220" class="headerlink" title="R6220"></a>R6220</h3><p>根据网上的文档<a href="https://opssh.cn/luyou/205.html%E5%AE%89%E8%A3%85breed%E3%80%82">https://opssh.cn/luyou/205.html安装breed。</a><br>breed下载网址<a href="https://breed.hackpascal.net/">https://breed.hackpascal.net/</a><br>对应R6220的文件是breed-mt7621-r6220.bin</p>
<h2 id="无线中继方案"><a href="#无线中继方案" class="headerlink" title="无线中继方案"></a>无线中继方案</h2><p>主路由R3G,接移动硬盘，USB3.0速度可以达到读90+MB&#x2F;s,写40+MB&#x2F;s。<br>主路由可以选择官方固件或者其他Padavan, openwrt。</p>
<h3 id="主路由R3G"><a href="#主路由R3G" class="headerlink" title="主路由R3G"></a>主路由R3G</h3><p>理论上可以选择任何固件。</p>
<p>R3G官方固件高级设置里有漫游功能。但不知道是否是802.11k&#x2F;v&#x2F;r协议。所以没选。</p>
<p>Padavan固件4.x.100版本中有k&#x2F;v&#x2F;r支持。还支持USB3.0，网络共享，科学上网。所以选用此固件。</p>
<p>Openwrt官方待测。</p>
<h3 id="副路由R6220"><a href="#副路由R6220" class="headerlink" title="副路由R6220"></a>副路由R6220</h3><p>副路由R6220必须是openwrt，官方openwrt固件就可以。因为需要的中继relayd, 打印服务p910nd都可以作为插件安装。</p>
<p>副路由为什么不选官方固件和Padavan?<br>官方固件有中继模式，可以中继，而且很方便。但是选择中继模式后文件服务器或者打印服务器都不能再用，USB口相当于浪费了。<br>Padavan目前固件也可以中继。但是没有打印服务器功能。R3G的Padavan固件版本新，可以做打印服务器。但是中继时路由器无法指定固定IP，作为打印服务器或者文件服务器都不方便。</p>
<p>R6220安装官方openwrt固件并安装插件。</p>
<p>安装breed后，同时按wps键和开关键开机，大概4秒后电源指示灯闪几下，网线连接WAN口，浏览器访问192.168.1.1就可以打开breed界面。</p>
<p>然后下载官网固件22.03.1 (截至2022.10)<br><a href="https://openwrt.org/toh/netgear/r6220">https://openwrt.org/toh/netgear/r6220</a></p>
<p><a href="https://downloads.openwrt.org/releases/22.03.2/targets/ramips/mt7621/openwrt-22.03.2-ramips-mt7621-netgear_r6220-squashfs-factory.img%E6%98%AF%E5%9C%A8breed%E4%B8%AD%E7%94%A8%E7%9A%84%E5%88%B7%E6%9C%BA%E5%9B%BA%E4%BB%B6%E3%80%82">https://downloads.openwrt.org/releases/22.03.2/targets/ramips/mt7621/openwrt-22.03.2-ramips-mt7621-netgear_r6220-squashfs-factory.img是在breed中用的刷机固件。</a></p>
<p><a href="https://downloads.openwrt.org/releases/22.03.2/targets/ramips/mt7621/openwrt-22.03.2-ramips-mt7621-netgear_r6220-squashfs-sysupgrade.bin%E6%98%AF%E5%9C%A8openwrt%E4%B8%AD%E5%8D%87%E7%BA%A7%E7%9A%84%E5%9B%BA%E4%BB%B6%E3%80%82">https://downloads.openwrt.org/releases/22.03.2/targets/ramips/mt7621/openwrt-22.03.2-ramips-mt7621-netgear_r6220-squashfs-sysupgrade.bin是在openwrt中升级的固件。</a></p>
<p>安装插件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1. 中继 (https://openwrt.org/docs/guide-user/network/wifi/relay_configuration)</span><br><span class="line">relayd</span><br><span class="line">luci-proto-relay</span><br><span class="line"></span><br><span class="line">2. USB打印机 (https://openwrt.org/docs/guide-user/services/print_server/p910ndprinterserver)</span><br><span class="line">kmod-usb-printer</span><br><span class="line">p910nd</span><br><span class="line">luci-app-p910nd</span><br><span class="line">luci-i18n-p910nd-zh-cn</span><br><span class="line"></span><br><span class="line">3. 界面汉化</span><br><span class="line">luci-i18n-base-zh-cn</span><br><span class="line">luci-i18n-firewall-zh-cn</span><br><span class="line">luci-i18n-opkg-zh-cn</span><br><span class="line"></span><br><span class="line">4. 阿里云webdav (https://github.com/messense/aliyundrive-webdav)</span><br><span class="line">wget https://github.com/messense/aliyundrive-webdav/releases/download/v1.10.1/aliyundrive-webdav_1.10.1-1_mipsel_24kc.ipk</span><br><span class="line">wget https://github.com/messense/aliyundrive-webdav/releases/download/v1.10.1/luci-app-aliyundrive-webdav_1.10.1_all.ipk</span><br><span class="line">wget https://github.com/messense/aliyundrive-webdav/releases/download/v1.10.1/luci-i18n-aliyundrive-webdav-zh-cn_1.10.1-1_all.ipk</span><br><span class="line">opkg install aliyundrive-webdav_1.10.1-1_aarch64_generic.ipk</span><br><span class="line">opkg install luci-app-aliyundrive-webdav_1.10.1_all.ipk</span><br><span class="line">opkg install luci-i18n-aliyundrive-webdav-zh-cn_1.10.1-1_all.ipk</span><br></pre></td></tr></table></figure>

<p>启动openwrt后，按照这个文章配置无线中继。<a href="https://openwrt.org/docs/guide-user/network/wifi/relay_configuration">https://openwrt.org/docs/guide-user/network/wifi/relay_configuration</a></p>
<p>配置时注意的要点</p>
<ol>
<li>副路由的IP必须是另一个网段(192.168.3.1)。</li>
<li>必须关闭副路由的DHCP，包括IPV6。关闭后，电脑连路由器必须改成静态IP192.168.3.2。</li>
<li>relayd相关的插件如下<br>kmod-usb-printer<br>p910nd<br>luci-app-p910nd<br>luci-i18n-p910nd-zh-cn</li>
</ol>
<p>注：目前我没有用上面的官方固件。用的是自编译的固件，把relayd, p910nd,samba和easymesh等相关功能都编译进去了。路由器重置也不需要重新安装插件。</p>
<h2 id="easymesh方案-因为R3G自编译带easymesh的openwrt不稳定，放弃easymesh"><a href="#easymesh方案-因为R3G自编译带easymesh的openwrt不稳定，放弃easymesh" class="headerlink" title="easymesh方案 (因为R3G自编译带easymesh的openwrt不稳定，放弃easymesh)"></a>easymesh方案 (因为R3G自编译带easymesh的openwrt不稳定，放弃easymesh)</h2><p>这个方案需要主副路由都刷openwrt，而且必须是自己编译的openwrt。因为必须用到easymesh。而easymesh不能作为插件安装，必须编译到内核中，所以只能选择自编译。</p>
<p>注: (2022.10.26)主路由R3G的自编译openwrt使用期间发生过5G wifi速率降到14Mb&#x2F;s。必须重启才能恢复。而且连续发生两天。路由器最重要的是稳定。不知道是否是easymesh引起的问题。暂时放弃此方案。改用官方固件无线中继模式。</p>
<h3 id="编译R3G-openwrt"><a href="#编译R3G-openwrt" class="headerlink" title="编译R3G openwrt"></a>编译R3G openwrt</h3><p>选择LEDE(<a href="https://github.com/coolsnowwolf/lede)%EF%BC%8C%E8%BF%99%E4%B8%AA%E7%89%88%E6%9C%AC%E5%9F%BA%E4%BA%8Eopenwrt,%E8%80%8C%E4%B8%94%E9%9B%86%E6%88%90%E4%BA%86easymesh%E5%92%8C%E5%85%B6%E4%BB%96%E6%9C%89%E7%94%A8%E7%9A%84%E6%8F%92%E4%BB%B6%EF%BC%8C%E6%9B%B4%E6%96%B9%E4%BE%BF%E3%80%82">https://github.com/coolsnowwolf/lede)，这个版本基于openwrt,而且集成了easymesh和其他有用的插件，更方便。</a></p>
<p>编译环境: Ubuntu 18.04.6 LTS (Bionic Beaver)<br>磁盘空间大约需要70G.</p>
<p>具体步骤按照<a href="https://github.com/coolsnowwolf/lede%E9%A1%B5%E9%9D%A2%E8%AF%B4%E6%98%8E%E7%9A%84%E5%81%9A%E3%80%82">https://github.com/coolsnowwolf/lede页面说明的做。</a></p>
<p>步骤就是文档中提到的，编译我选择2或3线程。选择1线程需要编译4个小时以上。</p>
<p>make V&#x3D;s -j2</p>
<p>我的目标是在默认配置下，做如下更改</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+磁盘管理system/diskman</span><br><span class="line">-上网时间控制 services/mia</span><br><span class="line">-动态DNSservices/ddns</span><br><span class="line"></span><br><span class="line">+automount</span><br><span class="line">+打印服务器 nas/p910nd</span><br><span class="line">+FTP服务器nas/vsftpd</span><br><span class="line">+网络共享nas/samba</span><br><span class="line"></span><br><span class="line">+简单MESH network/easymesh</span><br></pre></td></tr></table></figure>

<p>在make menuconfig那一步，我按照如下选择模块。这个选择加入如下功能</p>
<ol>
<li><p>USB3.0文件存储支持。支持常见的几种文件系统(NTFS, FAT, FAT32, ext4等)</p>
</li>
<li><p>磁盘管理，可以自动mount U盘。</p>
</li>
<li><p>easymesh</p>
</li>
<li><p>打印服务器</p>
</li>
<li><p>文件共享</p>
</li>
<li><p>访客网络</p>
</li>
<li><p>终端</p>
</li>
<li><p>加了两个主题，增加了英语</p>
</li>
<li><p>中继模块</p>
</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Target System (MediaTek Ralink MIPS)</span><br><span class="line">Subtarget (MT7621 based boards)</span><br><span class="line">Target Profile (Xiaomi Mi Router 3G)</span><br><span class="line"></span><br><span class="line">LuCI-&gt;Applications</span><br><span class="line">+ luci-app-diskman......................... Disk Manager interface for LuCI</span><br><span class="line">+ Include lsblk</span><br><span class="line">+ luci-app-easymesh.............................. LuCI Support for easymesh</span><br><span class="line">+ luci-app-guest-wifi.......................... LuCI support for guest-wifi</span><br><span class="line">+ luci-app-p910nd........................... p910nd - Printer server module</span><br><span class="line">+ luci-app-samba.................... Network Shares - Samba SMB/CIFS module</span><br><span class="line">+ luci-app-ttyd...................................... LuCI support for ttyd</span><br><span class="line">- luci-app-vlmcsd..................................... LuCI support for KMS</span><br><span class="line">- luci-app-wol................................ LuCI Support for Wake-on-LAN</span><br><span class="line"></span><br><span class="line">LuCI-&gt;Themes</span><br><span class="line">+ luci-theme-material....................................... Material Theme</span><br><span class="line">+ luci-theme-netgear......................................... Netgear Theme</span><br><span class="line"></span><br><span class="line">LuCI-&gt;Protocols</span><br><span class="line">+ luci-proto-ipv6........... Support for DHCPv6/6in4/6to4/6rd/DS-Lite/aiccu</span><br><span class="line">+ luci-proto-relay....................... Support for relayd pseudo bridges</span><br><span class="line"></span><br><span class="line">LuCI-&gt;Modules -&gt; Translations</span><br><span class="line">+ English (en)</span><br><span class="line"></span><br><span class="line">Extra packages</span><br><span class="line">+ automount............................... Mount autoconfig hotplug script (这个选择后会自动选择Kernel modules-&gt;Filesystems下的很多模块，如果需要支持更多的文件系统，需要在里面增加相应模块)</span><br><span class="line"></span><br><span class="line">Kernel modules-&gt;USB Support</span><br><span class="line">+ kmod-usb-storage-uas.................... USB Attached SCSI (UASP) support (选择这个才能让R3G路由器支持USB3.0，否则读写速度只有20多M，打开后读可以90+M,写可以40+M)</span><br><span class="line">+ kmod-usb-printer.................................... Support for printers (打印机需要)</span><br></pre></td></tr></table></figure>

<p>如果对配置不满意，可以重新配置<br>删除.config<br>cd ~&#x2F;dev&#x2F;openwrt&#x2F;lede<br>git pull （这个目的是为了更新代码）<br>rm .config<br>make menuconfig</p>
<h3 id="编译R6220-openwrt"><a href="#编译R6220-openwrt" class="headerlink" title="编译R6220 openwrt"></a>编译R6220 openwrt</h3><p>因为R6220和R3G用的CPU都是MT7621,所以配置几乎一样。唯一的区别是</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Target System (MediaTek Ralink MIPS)</span><br><span class="line">Subtarget (MT7621 based boards)</span><br><span class="line">Target Profile (Netgear R6220)</span><br></pre></td></tr></table></figure>

<h4 id="R6220-openwrt-2-4G丢失问题"><a href="#R6220-openwrt-2-4G丢失问题" class="headerlink" title="R6220 openwrt 2.4G丢失问题"></a>R6220 openwrt 2.4G丢失问题</h4><blockquote>
<p><a href="https://github.com/openwrt/openwrt/issues/9374">mt7621: R6220 2.4GHz radio0 issues
</a></p>
</blockquote>
<p>“wifiseguro”的回答</p>
<p>Just add a file in patches folder ie:<br>target&#x2F;linux&#x2F;ramips&#x2F;patches-5.10&#x2F;901-staging-mt7621-pci-delay-for-properly-detect.patch</p>
<figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/drivers/staging/mt7621-pci/pci-mt7621.c</span></span><br><span class="line"><span class="comment">+++ b/drivers/staging/mt7621-pci/pci-mt7621.c</span></span><br><span class="line"><span class="meta">@@ -502,8 +502,9 @@</span></span><br><span class="line"> 	int err;</span><br><span class="line"> </span><br><span class="line"> 	rt_sysc_m32(PERST_MODE_MASK, PERST_MODE_GPIO, MT7621_GPIO_MODE);</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+	mdelay(250);</span></span><br><span class="line"> 	mt7621_pcie_reset_assert(pcie);</span><br><span class="line"><span class="addition">+	mdelay(250);</span></span><br><span class="line"> 	mt7621_pcie_reset_rc_deassert(pcie);</span><br><span class="line"> </span><br><span class="line"> 	list_for_each_entry_safe(port, tmp, &amp;pcie-&gt;ports, list) &#123;</span><br><span class="line"><span class="meta">@@ -520,7 +521,7 @@</span></span><br><span class="line"> 			list_del(&amp;port-&gt;list);</span><br><span class="line"> 		&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="addition">+	mdelay(250);</span></span><br><span class="line"> 	mt7621_pcie_reset_ep_deassert(pcie);</span><br><span class="line"> </span><br><span class="line"> 	tmp = NULL;</span><br></pre></td></tr></table></figure>

<p>我找到了3个带patches-5xxx的目录</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quxr@quxr-ThinkPad-X201:~/dev/openwrt/lede$ find . -name &quot;patches-5*&quot;|grep ramips</span><br><span class="line">./target/linux/ramips/patches-5.15</span><br><span class="line">./target/linux/ramips/patches-5.10</span><br><span class="line">./target/linux/ramips/patches-5.4</span><br></pre></td></tr></table></figure>

<p>我认为应该加到patches-5.4,因为R6220用的是这个目录。但是为了稳妥起见，我在三个目录都加了。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">quxr@quxr-ThinkPad-X201:~/dev/openwrt/lede$ find . -name &quot;901-staging-mt7621-pci-delay-for-properly-detect.patch&quot;</span><br><span class="line">./target/linux/ramips/patches-5.15/901-staging-mt7621-pci-delay-for-properly-detect.patch</span><br><span class="line">./target/linux/ramips/patches-5.10/901-staging-mt7621-pci-delay-for-properly-detect.patch</span><br><span class="line">./target/linux/ramips/patches-5.4/901-staging-mt7621-pci-delay-for-properly-detect.patch</span><br></pre></td></tr></table></figure>

<p>然后重新编译就可以了。<br>从patch看，就是加了几处延时。但的确立即解决2.4G找不到的问题。</p>
<h2 id="旁路由网关"><a href="#旁路由网关" class="headerlink" title="旁路由网关"></a>旁路由网关</h2><p>主路由是R3G刷openwrt, 192.168.1.1<br>用ZTE E8820S刷openwrt无线中继，接打印机, 192.168.1.101<br>N1装armbian接在R3G,192.168.1.108<br>  N1下docker运行openwrt做旁路由网关192.168.1.111<br>CM311-1sa装armbian接在E8820S下,192.168.1.106<br>  CM311-1sa下docker运行openwrt做另外一个旁路由网关192.168.1.112</p>
<p>电脑x201通过wifi接入R3G上网。</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置192.168.1.111为默认网关</span></span><br><span class="line">sudo route add default gw 192.168.1.111 wlp2s0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除192.168.1.111网关</span></span><br><span class="line">sudo route delete default gw 192.168.1.111 wlp2s0</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置192.168.1.112为默认网关</span></span><br><span class="line">sudo route add default gw 192.168.1.112 wlp2s0</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除192.168.1.112网关</span></span><br><span class="line">sudo route delete default gw 192.168.1.112 wlp2s0</span><br></pre></td></tr></table></figure>

<p>症状:一开始旁路由能工作，但是不知道什么原因就不工作了。排除了host接在主路由或者无线桥接的可能。因为无论接在哪都一样。有时候好用有时候不好用。</p>
<p>根据这篇文章</p>
<blockquote>
<p><a href="https://blog.csdn.net/qq1337715208/article/details/122271608">https://blog.csdn.net/qq1337715208/article/details/122271608</a><br><a href="https://cloud.tencent.com/developer/article/2036952">https://cloud.tencent.com/developer/article/2036952</a></p>
</blockquote>
<p>最后，旁路由不需要添加防火墙“iptables -t nat -I POSTROUTING -j MASQUERADE”，只在主路由R3G里做如下修改</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@R3G:/etc# echo &#x27;net.bridge.bridge-nf-call-ip6tables=0&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">root@R3G:/etc# echo &#x27;net.bridge.bridge-nf-call-iptables=0&#x27; &gt;&gt; /etc/sysctl.conf </span><br><span class="line">root@R3G:/etc# echo &#x27;net.bridge.bridge-nf-call-arptables=0&#x27; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">root@R3G:/etc# sysctl -p /etc/sysctl.conf </span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 0</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>

<p>然后根据上面的命令使用旁路由为默认网关就可以上网了。</p>
<p>其他记录</p>
<p>在106,108上创建docker openwrt</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link set eth0 promisc on</span><br><span class="line">docker network create -d macvlan --subnet=192.168.1.0/24 --gateway=192.168.1.1 -o parent=eth0 macnet</span><br><span class="line">docker pull registry.cn-shanghai.aliyuncs.com/suling/openwrt:armv8</span><br><span class="line">docker run --restart always --name openwrt -d --network macnet --privileged registry.cn-shanghai.aliyuncs.com/suling/openwrt:armv8 /sbin/init</span><br><span class="line"></span><br><span class="line">docker exec -it openwrt bash</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight console"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo ip link set eth0 promisc on</span><br><span class="line">docker network create -d macvlan --subnet=192.168.1.0/24 --gateway=192.168.1.1 -o parent=eth0 macnet108</span><br><span class="line">docker run --restart always -d --name=openwrt --network macnet108 --privileged unifreq/openwrt-aarch64 /sbin/init</span><br><span class="line"></span><br><span class="line">docker exec -it openwrt bash</span><br></pre></td></tr></table></figure>
</div></article><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/12/13/nginx-proxy/"><i class="fa fa-chevron-left">  </i><span>nginx反向代理(非docker)</span></a></div><div class="next-post pull-right"><a href="/2022/10/03/router-stuff/"><span>路由器相关</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2025 By Ray Qu</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>